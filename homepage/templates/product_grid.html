{% for product in products %}
<div class="col">
    <div class="card product-card h-100 border-0 shadow-sm position-relative">
        {% if user.is_authenticated %}
        <button class="wishlist-btn position-absolute top-0 end-0 m-2 btn btn-link p-1 {% if product.is_wishlisted %}text-danger{% else %}text-muted{% endif %}" 
                data-product-id="{{ product.id }}" 
                data-product-size="{{ product.variants.first.size }}"
                data-product-color="{{ product.variants.first.color }}"
                onclick="toggleWishlist(this)">
            <i class="fas fa-heart fa-lg"></i>
        </button>
        {% endif %}
        
        <a href="{% url 'product_detail' product.id %}" class="text-decoration-none">
            <img src="{{ product.images.first.image }}" 
                 class="card-img-top product-image" 
                 alt="{{ product.name }}">
            <div class="card-body">
                <h5 class="card-title h6">{{ product.name|truncatechars:15 }}</h5>
                <div class="product-rating">
                    {% with ''|center:5 as range %}
                    {% for _ in range %}
                        {% if forloop.counter <= product.avg_rating|floatformat:0|add:"0" %}
                            <span class="star filled">★</span>
                        {% else %}
                            <span class="star">☆</span>
                        {% endif %}
                    {% endfor %}
                    {% endwith %}
                    <span class="rating-count">({{ product.review_count }})</span>
                </div>
                {% with variant=product.variants.first %}
                <div class="d-flex align-items-center mt-2">
                    <span class="original-price">₹{{ variant.actual_price }}</span>
                    <span class="sale-price">₹{{ variant.sale_price }}</span>
                </div>
                {% endwith %}
            </div>
        </a>
        
        {% if user.is_authenticated %}
        <div class="card-footer bg-transparent border-0 pt-0">
            {% with variant=product.variants.first %}
            {% if variant.quantity > 0 %}
            <button class="btn btn-dark btn-sm w-100 add-to-cart-btn" 
                    data-product-id="{{ product.id }}" 
                    data-variant-id="{{ variant.id }}">
                <i class="fas fa-shopping-cart me-1"></i> Add to Cart
            </button>
            {% else %}
            <button class="btn btn-secondary btn-sm w-100" disabled>
                Out of Stock
            </button>
            {% endif %}
            {% endwith %}
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

<script>
function toggleWishlist(button) {
    const productId = button.dataset.productId;
    const productSize = button.dataset.productSize;
    const productColor = button.dataset.productColor;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const wasWishlisted = button.classList.contains('text-danger');
    
    // Show loading state
    const heartIcon = button.querySelector('i');
    const originalIcon = heartIcon.className;
    heartIcon.className = 'fas fa-spinner fa-spin fa-lg';
    button.disabled = true;

    const formData = new FormData();
    formData.append('color', productColor);

    fetch(`{% url 'toggle_wishlist' 0 'size' %}`.replace('0', productId).replace('size', productSize), {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Restore original icon
        heartIcon.className = originalIcon;
        button.disabled = false;
        
        if (data.success) {
            if (!wasWishlisted) {
                // Item was added to wishlist
                button.classList.remove('text-muted');
                button.classList.add('text-danger');
                Toastify({
                    text: "Added to wishlist!",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "linear-gradient(to right, #28a745, #5cd85d)",
                        color: "#fff",
                        borderRadius: "12px",
                        boxShadow: "0px 4px 6px rgba(0, 0, 0, 0.1)"
                    },
                }).showToast();
            } else {
                // Item was removed from wishlist
                button.classList.remove('text-danger');
                button.classList.add('text-muted');
                Toastify({
                    text: "Removed from wishlist!",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "linear-gradient(to right, #dc3545, #ff6b6b)",
                        color: "#fff",
                        borderRadius: "12px",
                        boxShadow: "0px 4px 6px rgba(0, 0, 0, 0.1)"
                    },
                }).showToast();
            }
        } else {
            Toastify({
                text: data.message || "Error updating wishlist",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "center",
                style: {
                    background: "linear-gradient(to right, #dc3545, #ff6b6b)",
                    color: "#fff",
                    borderRadius: "12px",
                    boxShadow: "0px 4px 6px rgba(0, 0, 0, 0.1)"
                },
            }).showToast();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        heartIcon.className = originalIcon;
        button.disabled = false;
        Toastify({
            text: "Something went wrong. Please try again.",
            duration: 3000,
            close: true,
            gravity: "top",
            position: "center",
            style: {
                background: "linear-gradient(to right, #dc3545, #ff6b6b)",
                color: "#fff",
                borderRadius: "12px",
                boxShadow: "0px 4px 6px rgba(0, 0, 0, 0.1)"
            },
        }).showToast();
    });
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const variantId = this.dataset.variantId;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Adding...';
            this.disabled = true;

            const formData = new FormData();
            formData.append('variant', variantId);
            formData.append('quantity', '1');

            fetch(`{% url 'add_to_cart' 0 %}`.replace('0', productId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData
            })
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    throw new Error('Server returned HTML instead of JSON - check URL routing');
                }
            })
            .then(data => {
                if (data.success !== false) {
                    window.location.href = '{% url "view_cart" %}';
                } else {
                    this.innerHTML = originalText;
                    this.disabled = false;
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('[v0] Add to cart error:', error);
                this.innerHTML = originalText;
                this.disabled = false;
                window.location.reload();
            });
        });
    });
});
</script>
